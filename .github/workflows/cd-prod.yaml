name: CD - Deploy to Prod (Promote Dev Image)

on:
  release:
    types: [published]
  workflow_dispatch:
    inputs:
      version:
        description: 'Version tag (e.g., v1.0.0)'
        required: true
      source_tag:
        description: 'Source image tag to promote (default: dev)'
        required: false
        default: 'dev'

env:
  REGISTRY: ghcr.io
  PRODUCT_IMAGE_NAME: ${{ github.repository_owner }}/product-service
  ORDER_IMAGE_NAME: ${{ github.repository_owner }}/order-service

jobs:
  promote-product-service:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    steps:
      - name: Log in to Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Get version
        id: version
        run: |
          if [ "${{ github.event_name }}" = "release" ]; then
            echo "version=${{ github.event.release.tag_name }}" >> $GITHUB_OUTPUT
            echo "source_tag=dev" >> $GITHUB_OUTPUT
          else
            echo "version=${{ github.event.inputs.version }}" >> $GITHUB_OUTPUT
            echo "source_tag=${{ github.event.inputs.source_tag }}" >> $GITHUB_OUTPUT
          fi

      - name: Pull dev image
        run: |
          docker pull ${{ env.REGISTRY }}/${{ env.PRODUCT_IMAGE_NAME }}:${{ steps.version.outputs.source_tag }}

      - name: Tag and push as prod version
        run: |
          # Tag with version
          docker tag \
            ${{ env.REGISTRY }}/${{ env.PRODUCT_IMAGE_NAME }}:${{ steps.version.outputs.source_tag }} \
            ${{ env.REGISTRY }}/${{ env.PRODUCT_IMAGE_NAME }}:${{ steps.version.outputs.version }}

          # Tag as prod (latest stable)
          docker tag \
            ${{ env.REGISTRY }}/${{ env.PRODUCT_IMAGE_NAME }}:${{ steps.version.outputs.source_tag }} \
            ${{ env.REGISTRY }}/${{ env.PRODUCT_IMAGE_NAME }}:prod

          # Push both tags
          docker push ${{ env.REGISTRY }}/${{ env.PRODUCT_IMAGE_NAME }}:${{ steps.version.outputs.version }}
          docker push ${{ env.REGISTRY }}/${{ env.PRODUCT_IMAGE_NAME }}:prod

      - name: Log promotion
        run: |
          echo "✅ Promoted product-service:${{ steps.version.outputs.source_tag }} → ${{ steps.version.outputs.version }}"

  promote-order-service:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    steps:
      - name: Log in to Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Get version
        id: version
        run: |
          if [ "${{ github.event_name }}" = "release" ]; then
            echo "version=${{ github.event.release.tag_name }}" >> $GITHUB_OUTPUT
            echo "source_tag=dev" >> $GITHUB_OUTPUT
          else
            echo "version=${{ github.event.inputs.version }}" >> $GITHUB_OUTPUT
            echo "source_tag=${{ github.event.inputs.source_tag }}" >> $GITHUB_OUTPUT
          fi

      - name: Pull dev image
        run: |
          docker pull ${{ env.REGISTRY }}/${{ env.ORDER_IMAGE_NAME }}:${{ steps.version.outputs.source_tag }}

      - name: Tag and push as prod version
        run: |
          # Tag with version
          docker tag \
            ${{ env.REGISTRY }}/${{ env.ORDER_IMAGE_NAME }}:${{ steps.version.outputs.source_tag }} \
            ${{ env.REGISTRY }}/${{ env.ORDER_IMAGE_NAME }}:${{ steps.version.outputs.version }}

          # Tag as prod (latest stable)
          docker tag \
            ${{ env.REGISTRY }}/${{ env.ORDER_IMAGE_NAME }}:${{ steps.version.outputs.source_tag }} \
            ${{ env.REGISTRY }}/${{ env.ORDER_IMAGE_NAME }}:prod

          # Push both tags
          docker push ${{ env.REGISTRY }}/${{ env.ORDER_IMAGE_NAME }}:${{ steps.version.outputs.version }}
          docker push ${{ env.REGISTRY }}/${{ env.ORDER_IMAGE_NAME }}:prod

      - name: Log promotion
        run: |
          echo "✅ Promoted order-service:${{ steps.version.outputs.source_tag }} → ${{ steps.version.outputs.version }}"

  update-helm-values:
    needs: [promote-product-service, promote-order-service]
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          ref: master
          fetch-depth: 0

      - name: Get version
        id: version
        run: |
          if [ "${{ github.event_name }}" = "release" ]; then
            echo "version=${{ github.event.release.tag_name }}" >> $GITHUB_OUTPUT
          else
            echo "version=${{ github.event.inputs.version }}" >> $GITHUB_OUTPUT
          fi

      - name: Update Product Service image tag
        run: |
          sed -i "s|tag: \".*\"|tag: \"${{ steps.version.outputs.version }}\"|" charts/product-service/values-prod.yaml

      - name: Update Order Service image tag
        run: |
          sed -i "s|tag: \".*\"|tag: \"${{ steps.version.outputs.version }}\"|" charts/order-service/values-prod.yaml

      - name: Commit and push
        run: |
          git config --global user.name 'GitHub Actions'
          git config --global user.email 'actions@github.com'
          git add charts/*/values-prod.yaml
          git diff --staged --quiet || git commit -m "chore: promote dev to prod ${{ steps.version.outputs.version }}"
          git push
